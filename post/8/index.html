<!doctype html><html lang=ko-KR dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="데이터를 일관되게 전달하도록 ORM을 제거하고 쿼리를 최적화해 보자"><title>[PostgreSQL] 데이터를 일관되게 전달해 보자</title>
<link rel=canonical href=https://fhdufhdu.github.io/post/8/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="[PostgreSQL] 데이터를 일관되게 전달해 보자"><meta property="og:description" content="데이터를 일관되게 전달하도록 ORM을 제거하고 쿼리를 최적화해 보자"><meta property="og:url" content="https://fhdufhdu.github.io/post/8/"><meta property="og:site_name" content="fhdufhdu"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="database"><meta property="article:tag" content="orm"><meta property="article:published_time" content="2024-01-10T14:34:00+09:00"><meta property="article:modified_time" content="2024-01-11T09:08:00+09:00"><meta name=twitter:title content="[PostgreSQL] 데이터를 일관되게 전달해 보자"><meta name=twitter:description content="데이터를 일관되게 전달하도록 ORM을 제거하고 쿼리를 최적화해 보자"><script async src="https://www.googletagmanager.com/gtag/js?id=G-7HWJJYSR48"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7HWJJYSR48",{anonymize_ip:!1})}</script><link rel=icon href=https://fhdufhdu.github.io/favicon.png><meta name=naver-site-verification content="6d753ef05b036bf72e177ec56685c036c230f81e"><meta name=google-site-verification content="Qvwxie2h5X0Fo-VCDyLZnJ8tNGARZmDZTZNVmsfWCVg"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel=stylesheet><style>@font-face{font-family:d2coding;src:url(/font/D2Coding.ttf)format('truetype');font-weight:400;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/100.woff2)format('woff2');font-weight:100;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/200.woff2)format('woff2');font-weight:200;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/300.woff2)format('woff2');font-weight:300;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/400.woff2)format('woff2');font-weight:400;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/500.woff2)format('woff2');font-weight:500;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/600.woff2)format('woff2');font-weight:600;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/700.woff2)format('woff2');font-weight:700;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/800.woff2)format('woff2');font-weight:800;font-style:normal}@font-face{font-family:pretendard;src:url(/font/pretendard/900.woff2)format('woff2');font-weight:900;font-style:normal}:root{--base-font-family:"Pretendard","Lato", var(--sys-font-family), var(--zh-font-family), sans-serif !important;--code-font-family:"JetBrains Mono", "Pretendard", Menlo, Monaco, Consolas, "Courier New", var(--zh-font-family), monospace!important;font-size:x-small;line-height:normal;.highlight { background-color: #272822; }}</style></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu95e3a12c0d9210c5dbd751eba0336b86_24679_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🤩</span></figure><div class=site-meta><h1 class=site-name><a href=/>fhdufhdu</a></h1><h2 class=site-description>의미있는 경험과 지식을 공유합니다</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/postgresql/>postgresql</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/8/>[PostgreSQL] 데이터를 일관되게 전달해 보자</a></h2><h3 class=article-subtitle>데이터를 일관되게 전달하도록 ORM을 제거하고 쿼리를 최적화해 보자</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-01-10 PM 2:34</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><h1 id=문제> 문제</h1><p><a class=link href=/post/7>1편의 문제</a>를 해결한 이후 새로운 이슈가 발생했다. 해당 이슈는 <code>게시글 리스트의 댓글 개수와 실제 게시글에 들어갔을 때 댓글 개수가 달라요</code> 이다. 이전에 수정한 코드가 문제가 있던 것은 아니고, 기존의 로직 자체의 문제였다.</p><p><img src=/post/8/image.png width=678 height=272 loading=lazy alt="게시글 리스트(기글하드웨어) - 해당 이미지는 예시입니다." class=gallery-image data-flex-grow=249 data-flex-basis=598px></p><p>위 이미지의 <code>델 oem 4090의 모험(완)</code> 게시글을 보면 댓글이 6개라고 나와 있다. 그런데, 실제로 해당 게시글을 클릭해서 들어가면 5개, 4개 같이 댓글 개수가 줄어드는 버그가 있었다.</p><p>이는 서비스의 댓글 정책에서 기인하는 문제이다. 해당 정책은 댓글의 노출이 필요한 조건이 복잡하다.</p><p>그래서 그랬을까? 애초에 기존 로직이 조금 이상했었다. 게시글 리스트를 가져올 때는 단순하게 삭제된 댓글을 제외한 개수를 가져와서 반환하고, 게시글 상세 정보 조회 시에는 실제로 댓글 리스트에 정책을 js 코드로 필터를 작성해서 반환했다. 그래서 댓글의 작성과 삭제가 빈번하게 일어나는 게시글일수록 점점 차이가 심하게 나기 시작했다.</p><p>솔직히 처음 코드를 보고 조금 벙쪘다. 아무리 그래도 그렇지&mldr; 두개의 댓글 개수 카운팅 방식이 같지 않다니&mldr;</p><h1 id=문제를-어떻게-해결할-것인가>문제를 어떻게 해결할 것인가</h1><p>문제의 원인을 파악하고 나서, 어떻게 해결할 지 고민이 많이 되었다. 곰곰히 생각하면서 세가지의 생각이 떠올랐다.</p><ol><li><strong>프론트엔드에게 처리 맞기기</strong><ul><li>절대 안된다.</li><li>프론트엔드에게 처리를 맞기면 똑같은 문제가 발생할 것이다.</li></ul></li><li><strong>게시글 목록 조회시 댓글도 싹다 불러와서 정책 필터 적용시키기</strong><ul><li>전체 게시글 개수(n) * 전체 댓글 개수(m) = <strong>O(n*m)</strong> 만큼의 시간 소모</li><li>뭔가 딱봐도 시간이 오래 걸릴 것 같은 느낌</li></ul></li><li><strong>orm을 제거하고 정책을 sql 쿼리에 녹여서 만들기</strong><ul><li>생각만해도 어렵고, 귀찮다.</li><li>근데 이 방법 밖에 없다.</li></ul></li></ol><p>결론은 sql 쿼리를 사용하는 것이었다. 하지만 여기에도 문제가 존재한다.</p><h3 id=추가-문제>추가 문제</h3><ul><li><strong>기존 response dto를 유지해야함.</strong><ul><li>이것이 제일 큰 문제이다.</li><li>orm은 join시 자동으로 아래 예시 처럼 nest object를 만들어준다.</li><li>기존 response dto는 orm의 nest object에 강하게 의존하고 있다.</li><li>sql로도 해당 nest object를 만들 수 있어야 한다.</li></ul></li></ul><p>일반적으로 sql로 내려받은 데이터는 object안에 object가 없는 평면적인 데이터이다. 이를 코드상으로 해결하기에는 꽤나 보기싫은 코드가 생겨나게 될 것이다.(많은 loop와 map을 이용한 코드)</p><p>상당히 보기 지저분한 코드가 나올 것이라고 예상할 수 있다. 또한 2중 중첩이 아니라. 3중,4중으로 가게되면 더욱 복잡해질 것이다.</p><p>답은 postgresql의 jsonb 기능이다. postgresql은 groub by 집계함수로 json을 만들어 낼 수가 있다. 이를 통해 결론적으로 nested object를 만들어 바로 반환할 것이다.</p><blockquote><p>postgresql에는 jsonb와 json 타입이 있다. jsonb는 바이너리, json은 텍스트이다. 바이너리로 구성된 jsonb는 내부 값 컨트롤(추가, 수정, 삭제)이 가능하다.</p></blockquote><h1 id=해결-과정>해결 과정</h1><h2 id=with절-적극-활용하기>with절 적극 활용하기</h2><p>postgresql에는 with절이라는 것이 있다. with절은 특정 select 구문을 한번 실행하고 임시로 저장해두는 역할을 한다. 비슷한 쿼리를 여러번 실행해야 하는 경우 속도 측면에서 엄청난 강점을 가진다. 이를 보통 <code>CTE(common table expression)</code>이라고 한다. (<a class=link href=/post/9>참고 링크</a>)</p><h2 id=대상-게시글-선택>대상 게시글 선택</h2><p>with절을 활용해 게시글을 조회한다. 해당 게시글 id로 댓글 조회 row 개수를 최소화 하는 목적을 가진다.</p><h2 id=댓글-선택>댓글 선택</h2><p>댓글 테이블의 self join을 통해 정책을 sql에 녹여낸다. self join시 row 개수가 많으면 시간이 오래 걸리므로 위의 게시글 조회를 저장해둔 결과를 가져와 댓글 범위를 최소화 한다. 이후 댓글과 유저를 join 한 후 유저 정보를 jsonb로 변환한다. 해당 결과도 with절로 저장해둔다.</p><h2 id=게시글과-댓글-조합-후-json-제작>게시글과 댓글 조합 후 json 제작</h2><p>대상 게시글과 댓글 정보를 이용해 join을 맺는다. 이를 통해 <code>게시글-댓글리스트</code>를 json으로 만들고 전달할 수 있게 된다.</p><h1 id=후기>후기</h1><p>해당 쿼리를 게시글 리스트 조회 API와 게시글 상세 조회 API 모두에 사용했다. 같은 쿼리를 사용함으로써 두 API의 데이터를 일관적으로 전달할 수 있었다. 또한 앞서 언급한 jsonb를 이용해서 response dto도 그대로 유지할 수 있었다.</p><p>의외로 추가적인 소득도 있었다. 속도가 <strong>1s에서 200ms 대로 줄었던 것이다.</strong> with절을 이용한 방식이 효과가 컸던 것 같다. 이번 문제를 해결하기 위해 처음으로 사용해본 것인데, 앞으로도 애용할 것 같다.</p><div id=fhdufhdu-card></div><script>const resize=()=>{var t=[],e=setInterval(()=>{images=document.querySelectorAll(".gallery"),images.length>0&&(images.forEach(e=>{const n=e=>e>1535?15:e<0?0:15/767*e-11520/767,t=n(window.innerWidth);e.style.padding=`0 ${t}em 0 ${t}em`}),clearInterval(e))},100)};window.addEventListener("resize",resize),resize()</script></section><footer class=article-footer><section class=article-tags><a href=/tags/database/>database</a>
<a href=/tags/orm/>orm</a></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on 2024-01-11 AM 9:08</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><div class="article-list--compact links"><article><a href=https://ysyblog.tistory.com/142 target=_blank rel=noopener><div class=article-details><h2 class=article-title>[PostgreSQL] CTE (WITH 절)</h2><footer class=article-time>YSY의 데이터분석 블로그</footer></div></a></article><article><a href=https://americanopeople.tistory.com/300 target=_blank rel=noopener><div class=article-details><h2 class=article-title>(PostgreSQL) JSON VS JSONB</h2><footer class=article-time>복세편살</footer></div></a></article><article><a href=https://postgresql.kr/blog/postgresql_jsonb.html target=_blank rel=noopener><div class=article-details><h2 class=article-title>jsonb 자료형 다루기</h2><footer class=article-time>postgresql.kr</footer></div></a></article></div><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/7/><div class=article-details><h2 class=article-title>[PostgreSQL] Select 쿼리 속도를 개선해 보자</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=fhdufhdu/fhdufhdu.github.io issue-term=pathname label=comment crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2023 -
2024 fhdufhdu</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>